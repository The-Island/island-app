/*!
 * Island.IO
 * v 0.1
 * Copyright(c) 2012 Sander Pick <sanderpick@gmail.com>
 */Island=function(a){function h(b,c){g%2==0?a(c).fadeTo(500,.75):a(c).fadeTo(500,1),g+=1}function i(){clearInterval(pulseTimer),clearTimeout(pulseCancel),a("#logo-a").show(),a("#logo-b").hide()}function o(){n.hide().html(k[m]),n.fadeIn("fast"),m++,m==k.length&&(m=0)}function p(b){k=k.concat(b),l++;if(l==j.length){a.fisherYates(k);var c=a.setIntervalObj(this,5e3,o);o()}}function q(){a(".comment-added").each(function(b){var c=a(this);c.data("ts")||c.data("ts",c.text()),c.text(Util.getRelativeTime(c.data("ts")))})}function s(b,c){x.empty(),a.get("/search/"+b,c)}function t(){a(".is-video").each(function(b){if(a(this).data().timer)return;var c=a("img",this),d=c.length,e=1,f=setInterval(function(){var b=e===0?d-1:e-1;a(c[b]).hide(),a(c[e]).show(),e+=e==d-1?1-d:1},2e3);a(this).data({timer:f})})}function v(b){var c,d,e,f,g=0,h=[];return{init:function(){d=a(b),this.start()},start:function(){e=d.height(),f=d.children(),a(f[0]).clone().appendTo(d),c=a.setIntervalObj(this,40,this.scroll)},update:function(){clearInterval(c),this.start()},scroll:function(){g-=4;if(-g>=e){g=0;if(h.length!=0){d.empty();for(var a=0;a<h.length;a++)h[a].appendTo(d);this.update()}}d.css({marginTop:g})},receive:function(b){h=[];for(var c=0;c<b.length;c++)h.push(a(b[c]))}}}function A(b){function p(){return Math.min(Math.max(j,(parseInt(c.innerWidth())+h)/(g+h)),k)}var c=a(b),d=50,e=25,f={"482px":1,"231px":"*"},g=231,h=20,i=20,j=2,k=4,l=2,m=0,n=0,o=[];return{collage:function(b,d){a(".grid-obj-hover").hide();var e=p();for(var f=0;f<e;f++)o[f]=0;b&&C()>x.offset().top&&(d=d||0,o[2]=o[3]=C()-c.offset().top+10+d),a(".each-grid-obj").each(function(b){var c=a(this),d=0,f=0,j=Math.max(Math.round(c.outerWidth()/g),1);for(var k=0;k<e-(j-1);k++)d=o[k]<o[d]?k:d;for(k=0;k<j;k++)f=Math.max(f,o[d+k]);for(k=0;k<j;k++)o[d+k]=parseInt(c.outerHeight())+i+f;c.css("left",d*(g+h)+m).css("top",f+n)}),y=Math.max.apply(null,o)}}}function B(){z.css({height:a("#search").height()+y})}function C(){var b=a("#recent-comments").length>0?a("#recent-comments"):a(".obj-comments");return b.length>0?b.offset().top+b.height()+20:0}function E(){C()!=D&&w.collage(!0)}function F(){a(this).fadeOut()}var b={green:"#b1dc36",orange:"#d04c38",blue:"#4bb8d7",pink:"#d12b83",lightgreen:"#eff8d7",lightorange:"#f6dbd7",black:"#1a1a1a",darkgray:"#404040",gray:"#808080",lightgray:"#b3b3b3",bordergray:"#cdcdcd",backgray:"#fcfcfb",mattegray:"#f2f2f2"},c,d,e=0,f={start:function(){d=setInterval(this.go,250),this.go()},stop:function(){clearInterval(d)},go:function(){e>350?e=0:e+=20,c.css({left:e})}},g=0,j=[],k=[],l=0,m=0,n,r=function(b,c,d){!d&&d!==0&&(c<10?d=0:c<30?d=1:c<55?d=2:c<80?d=3:c<105?d=4:d=5),a(b.children()).hide();for(var e=0;e<d;e++)a(b.children()[e]).show();return d},u,w,x,y,z,D;return{go:function(){function l(){var b=a(".signin-bg > img");if(b.length===0)return;var c=a(this),d=b.width()/b.height();b.width(c.width()),b.height(c.width()/d)}function S(){J.show(),I.removeClass("is-button-alert"),T()}function T(){O.css("color","gray"),P.css("color","gray"),R.css("color","gray")}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},a.setTimeoutObj=function(a,b,c,d){return setTimeout(function(){c.apply(a,d)},b)},a.setIntervalObj=function(a,b,c,d){return setInterval(function(){c.apply(a,d)},b)},a.fisherYates=function(a){var b=a.length;if(b==0)return!1;while(--b){var c=Math.floor(Math.random()*(b+1)),d=a[b],e=a[c];a[b]=e,a[c]=d}},a.isEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},a.put=function(b,c,d){"function"==typeof c&&(d=c,c={}),c._method="PUT",a.post(b,c,d,"json")},a.fn.serializeObject=function(){var b={},c=this.serializeArray();return a.each(c,function(){b[this.name]?(b[this.name].push||(b[this.name]=[b[this.name]]),b[this.name].push(this.value||"")):b[this.name]=this.value||""}),b},a.fn.itemID=function(){try{var b=a(this).attr("id").split("-");return b[b.length-1]}catch(c){return null}},a.fn.dropIn=function(){a(this).css({bottom:40}).animate({bottom:"-=20"},2e3,"easeOutExpo")},a(".flash").hide().fadeIn(1e3).bind("click",F),a(".is-highlight, .is-error").dropIn(),setTimeout(function(){a(".flash").each(F)},1e4),u=new v("#trend"),u.init(),a.setIntervalObj(this,5e3,q),q(),w=new A("#grid"),x=a("#grid"),z=a(".grid-wrap");if(x.hasClass("adjustable-grid")){D=C();var d=a(".trending-media-wrap").length>0?a(".trending-media-wrap"):a(".single-left");z.css({top:d.offset().top+d.height()+40}),w.collage(!0)}else w.collage();(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i))&&a("#footer").hide();if(window.location.hash!=="")try{window.history.replaceState("","",window.location.pathname)}catch(e){}a("video, audio").each(function(){jwplayer(a(this).attr("id")).setup({flashplayer:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/player.swf",skin:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/skins/bekle.zip"})}),t(),c=a("#landing-loader"),c.length===0&&(f.start=function(){}),twitterNames=a("#twitter-names").text().split(",");for(var g=0;g<twitterNames.length;g++)twitterNames[g]!="undefined"&&twitterNames[g]!=""&&j.push(twitterNames[g]);n=a("#twitter");for(var k in j)a.tweet({username:j[k],callback:p});a(window).resize(l),l(),a('form input[type="text"], form input[type="password"], form textarea').bind("focus",function(){a(this).hasClass("is-input-alert")&&a(this).removeClass("is-input-alert")});var m=a("#logo-a"),o=a("#logo-b"),y=[m,o];a("#header-left").bind("mouseover",function(){m.hide(),o.show(),h(y[0],y[1]),pulseTimer=a.setIntervalObj(this,500,h,y),pulseCancel=a.setTimeoutObj(this,5e3,i)}).bind("mouseout",function(){i()}),a("textarea").autogrow(),a(".grid-obj-img").live("mouseenter",function(){a(".grid-obj-hover",this.parentNode).show()}),a(".grid-obj-hover").live("mouseleave",function(){a(this).fadeOut(100)});var G=a("#search-box");G.bind("keyup search",function(b){var c=a(this).val().trim();x.empty(),""===c&&(c="__clear__"),s(c,function(b){if("success"===b.status){for(var c=0;c<b.data.results.length;c++)a(b.data.results[c]).appendTo(x);x.hasClass("adjustable-grid")?w.collage(!0):w.collage()}else console.log(b.message);t()})}).bind("focus",B),G.val()!==""&&G.trigger("keyup"),a(".grid-obj, .trending").live("click",function(b){b.preventDefault();var c=a(this).data();a.put("/hit/"+c.id,function(a){if("error"===a.status)return console.log(a.message);window.location="/"+c.key})}),a(".commentor-input-dummy").bind("focus",function(){a(this).hide(),a(this.nextElementSibling).show(),a(this.nextElementSibling.firstElementChild).focus(),E()}),a(".commentor-input").bind("blur",function(){this.value.trim()==""&&(a(this.parentNode).hide(),a(this).val("").css({height:32}),a(this.parentNode.previousElementSibling).show(),E())}).bind("keyup",E),a(".add-comment").bind("click",function(){var b=a(this.previousElementSibling).val();b=a("<div>").html(b).text().trim();if(b==="")return!1;a(this.previousElementSibling).val("").css({height:32}),a(this.parentNode).hide(),a(this.parentNode.previousElementSibling).show();var c=a(this).itemID();a.put("/comment/"+c,{body:b},function(a){if("error"===a.status)return console.log(a.message)})}),a(".obj-holder").bind("mouseenter",function(){a(".hearts",this).show()}).bind("mouseleave",function(){a(".hearts",this).hide()}),a(".hearts-wrap img, .hearts-back img").bind("mousedown",function(a){a.preventDefault()}),a(".hearts").each(function(){var b=a(this),c=parseInt(b.data("num")),d=0,e=0,f=a(".hearts-back",this),g=a(".hearts-wrap",this);c>0&&r(g,null,c),f.bind("mouseleave",function(a){r(g,null,c)}).bind("mousemove",function(a){d=a.pageX-f.offset().left,e=r(g,d)}).bind("click",function(b){c=e;var d=f.itemID();a.put("/rate/"+d,{val:e},function(a){if("error"===a.status)return console.log(a.message)})})}),a(".obj-details[data-date]").each(function(){var b=a(this),c=new Date(b.data("date")),d;switch(b.data("type")){case"media":d="Added "+Util.toLocaleString(c,"mmm d, yyyy");break;case"profile":d="Contributor since "+Util.toLocaleString(c,"m/d/yy")}b.text(d)}),a(".birthday").each(function(){var b=a(this);b.text(Util.getAge(b.text()))});var H=a("#media-form"),I=a("#add-media"),J=a("#add-media-mask"),K=a('input[name="post[title]"]'),L=a('textarea[name="post[body]"]'),M=a('input[name="post[meta.tags]"]'),N=a('input[name="my_file"]'),O=a('label[for="post[title]"]'),P=a('label[for="post[body]"]'),Q=a('label[for="post[meta.tags]"]'),R=a('label[for="my_file"]');J.each(function(a){var b=I.outerWidth(),c=I.outerHeight();J.css({width:b,height:c})}),J.bind("mouseenter",function(){var a=K.val().trim(),c=L.val().trim(),d=N.val();a!=""&&c!=""&&d!=""?(J.css("bottom",1e4).hide(),T()):(I.addClass("is-button-alert"),a==""&&O.css("color",b.orange),c==""&&P.css("color",b.orange),d==""&&R.css("color",b.orange))}).bind("mouseleave",S),I.bind("mouseleave",function(){J.css("bottom",0),S()}),H.transloadit({wait:!0,autoSubmit:!1,onSuccess:function(b){if(b.ok!="ASSEMBLY_COMPLETED"){alert("Upload failed. Please try again.");return}if(a.isEmpty(b.results)){alert("You must choose a file to contribute.");return}var c=H.serializeObject();c.params=JSON.parse(c.params),c.assembly=b,a.put("/insert",c,function(b){if("error"===b.status)return console.log(b.message);K.val(""),L.val(""),M.val(""),N=a('input[name="my_file"]')})}})},receiveMedia:function(b){var c=a(b);c.prependTo(x).css({opacity:0}),x.hasClass("adjustable-grid")?w.collage(!0):w.collage(),c.animate({opacity:1},500)},receiveComment:function(b,c){var d=a(b),e=a("#coms-"+c),f=a("#recent-comments");if(f.length>0){a(f.children()[f.children().length-1]).remove(),f.hasClass("no-member")&&a(".comment-title-name",d).remove(),d.hide().css({opacity:0}).appendTo(f),w.collage(!0,d.height());var g=a(".comment-added",d);g.data("ts",g.text()),g.text(Util.getRelativeTime(g.data("ts"))),setTimeout(function(){d.prependTo(f).show(250).animate({opacity:1},500)},100)}else e.length>0&&(d.hide().css({opacity:0}).prependTo(e),a("a.comment-title-parent",d).remove(),w.collage(!0,d.height()),setTimeout(function(){d.show(250).animate({opacity:1},500);var b=a(".comment-added",d);b.data("ts",b.text()),b.text(Util.getRelativeTime(b.data("ts")))},100))},receiveTrends:function(a,b){if(a)return console.log(a);u.receive(b)}}}(jQuery),now.receiveMedia=Island.receiveMedia,now.receiveComment=Island.receiveComment,now.receiveTrends=Island.receiveTrends;