/*!
 * Island.IO
 * v 0.1
 * Copyright(c) 2012 Sander Pick <sanderpick@gmail.com>
 */// Polyfills
(function(){var a=0,b=["ms","moz","webkit","o"];for(var c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})(),Island=function(a){function f(b,c){e%2==0?a(c).fadeTo(500,.75):a(c).fadeTo(500,1),e+=1}function g(){clearInterval(pulseTimer),clearTimeout(pulseCancel),a("#logo-a").show(),a("#logo-b").hide()}function m(){l.hide().html(i[k]),l.fadeIn("fast"),k++,k==i.length&&(k=0)}function n(b){i=i.concat(b),j++;if(j==h.length){a.fisherYates(i);var c=a.setIntervalObj(this,5e3,m);m()}}function o(){a(".comment-added").each(function(b){var c=a(this);c.data("ts")||c.data("ts",c.text()),c.text(Util.getRelativeTime(c.data("ts")))})}function q(b,c){v.empty(),a.get("/search/"+b,c)}function r(){a(".is-video").each(function(b){if(a(this).data().timer)return;var c=a("img",this),d=c.length,e=1,f=setInterval(function(){var b=e===0?d-1:e-1;a(c[b]).hide(),a(c[e]).show(),e+=e==d-1?1-d:1},2e3);a(this).data({timer:f})})}function t(b){var c,d,e=40,f,g,h,i=0,j=[],k=[],l=!0,m=null;return{init:function(){f=a(b);if(f.length===0)return;g=f.offset().top,this.start()},start:function(){h=f.height(),a(f.children()[0]).clone().appendTo(f),k=_.map(f.children(),function(b){return a("img",b).offset().top-g}),c=requestAnimationFrame(_.bind(this.scroll,this))},update:function(){cancelAnimationFrame(c),this.start()},scroll:function(a){var b=this;if(!d||a-d>e){d=Date.now(),i-=1;if(-i>=h){i=0,f.css({marginTop:i});if(j.length!==0){f.empty();for(var g=0;g<j.length;++g)j[g].appendTo(f);this.update()}}else f.css({marginTop:i});var n=m,o=_.find(k,function(a,b){return n=b,-i-a<0});n!==m&&(m=n,l=!0),l&&m!==null&&m!==0&&k[m-1]+(o-k[m-1])/2<-i?(l=!1,cancelAnimationFrame(c),f.animate({marginTop:-o+"px"},200,"easeOutExpo",function(){i=-o,c=requestAnimationFrame(_.bind(b.scroll,b))})):c=requestAnimationFrame(_.bind(b.scroll,b))}else c=requestAnimationFrame(_.bind(b.scroll,b))},receive:function(b){j=[];for(var c=0;c<b.length;c++)j.push(a(b[c]))}}}function y(b){function p(){return Math.min(Math.max(j,(parseInt(c.innerWidth())+h)/(g+h)),k)}var c=a(b),d=50,e=25,f={"482px":1,"231px":"*"},g=231,h=20,i=20,j=2,k=4,l=2,m=0,n=0,o=[];return{collage:function(b,d){var e=p();for(var f=0;f<e;f++)o[f]=0;b&&A()>v.offset().top&&(d=d||0,o[2]=o[3]=A()-c.offset().top+10+d),a(".each-grid-obj").each(function(b){var c=a(this),d=0,f=0,j=Math.max(Math.round(c.outerWidth()/g),1);for(var k=0;k<e-(j-1);k++)d=o[k]<o[d]?k:d;for(k=0;k<j;k++)f=Math.max(f,o[d+k]);for(k=0;k<j;k++)o[d+k]=parseInt(c.outerHeight())+i+f;c.css("left",d*(g+h)+m).css("top",f+n).show()}),w=Math.max.apply(null,o),c.height(w+100)}}}function z(){x.css({height:a("#search").height()+w})}function A(){var b=a("#recent-comments").length>0?a("#recent-comments"):a(".obj-comments");return b.length>0?b.offset().top+b.height()+20:0}function C(){A()!=B&&u.collage(!0)}function D(){a(this).fadeOut()}var b={green:"#b1dc36",orange:"#d04c38",blue:"#4bb8d7",pink:"#d12b83",lightgreen:"#eff8d7",lightorange:"#f6dbd7",black:"#1a1a1a",darkgray:"#404040",gray:"#808080",lightgray:"#b3b3b3",bordergray:"#cdcdcd",backgray:"#fcfcfb",mattegray:"#f2f2f2"},c={lines:17,length:0,width:3,radius:40,rotate:0,color:"#000",speed:2.2,trail:100,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},d=function(){var b=a(".signin-spinner").get(0),d=(new Spinner(c)).spin(b);return{start:function(){d.spin(b)},stop:function(){d.stop()}}},e=0,h=[],i=[],j=0,k=0,l,p=function(b,c,d){!d&&d!==0&&(c<10?d=0:c<30?d=1:c<55?d=2:c<80?d=3:c<105?d=4:d=5),a(b.children()).hide();for(var e=0;e<d;e++)a(b.children()[e]).show();return d},s,u,v,w,x,B;return{go:function(){function k(){var b=a(".signin-bg > img");if(b.length===0)return;var c=a(this),d=b.width()/b.height();b.width(c.width()),b.height(c.width()/d)}function N(){D.animate({opacity:[0,"easeOutExpo"],left:["+=300","linear"]},200,"easeOutExpo",function(){D.hide(),D.css({opacity:1,left:0}),w.fadeIn("fast"),H.focus()}),E.hide(),F.show()}function O(){w.animate({opacity:[0,"easeOutExpo"],left:["-=300","linear"]},200,function(){w.hide(),w.css({opacity:1,left:0}),D.fadeIn("fast"),K.focus()}),F.hide(),E.show()}function P(){G.removeClass("is-button-alert"),Q()}function Q(){H.removeClass("is-input-alert"),I.removeClass("is-input-alert")}function R(){J.removeClass("is-button-alert"),S()}function S(){K.removeClass("is-input-alert"),L.removeClass("is-input-alert"),M.removeClass("is-input-alert")}function T(){a(".signin-strategies").hide(),a(".signin-controls").hide(),a(".signin-forms").hide(),a(".signin-almost-there").hide(),a(".signin-spinner").show()}function U(){a(".signin-strategies").show(),a(".signin-controls").show(),a(".signin-forms").show(),a(".signin-almost-there").show(),a(".signin-spinner").hide()}function jb(){ab.show(),_.removeClass("is-button-alert"),kb()}function kb(){fb.css("color","gray"),gb.css("color","gray"),ib.css("color","gray")}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},a.setTimeoutObj=function(a,b,c,d){return setTimeout(function(){c.apply(a,d)},b)},a.setIntervalObj=function(a,b,c,d){return setInterval(function(){c.apply(a,d)},b)},a.fisherYates=function(a){var b=a.length;if(b==0)return!1;while(--b){var c=Math.floor(Math.random()*(b+1)),d=a[b],e=a[c];a[b]=e,a[c]=d}},a.isEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},a.put=function(b,c,d){"function"==typeof c&&(d=c,c={}),c._method="PUT",a.post(b,c,d,"json")},a.fn.serializeObject=function(){var b={},c=this.serializeArray();return a.each(c,function(){b[this.name]?(b[this.name].push||(b[this.name]=[b[this.name]]),b[this.name].push(this.value.trim()||"")):b[this.name]=this.value.trim()||""}),b},a.fn.itemID=function(){try{var b=a(this).attr("id").split("-");return b[b.length-1]}catch(c){return null}},s=new t("#trend"),s.init(),a.setIntervalObj(this,5e3,o),o(),u=new y("#grid"),v=a("#grid"),x=a(".grid-wrap");if(v.hasClass("adjustable-grid")){B=A();var c=a(".trending-media-wrap").length>0?a(".trending-media-wrap"):a(".single-left");x.css({top:c.offset().top+c.height()+40}),u.collage(!0)}else u.collage();(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i))&&a("#footer").hide();if(window.location.hash!=="")try{window.history.replaceState("","",window.location.pathname+window.location.search)}catch(e){}a(".jp-jplayer").each(function(b){a("#"+a(this).attr("id")).jPlayer({ready:function(b){a(this).jPlayer("setMedia",{mp3:a(this).data("src")})},play:function(){a(this).jPlayer("pauseOthers")},swfPath:"https://d271mvlc6gc7bl.cloudfront.net/main/jplayer/js",wmode:"window",cssSelectorAncestor:"#jp_container_"+(b+1)})}),a("video").each(function(){jwplayer(a(this).attr("id")).setup({flashplayer:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/player.swf",skin:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/skins/bekle.zip"})}),r(),twitterNames=a("#twitter-names").text().split(",");for(var i=0;i<twitterNames.length;i++)twitterNames[i]!="undefined"&&twitterNames[i]!=""&&h.push(twitterNames[i]);l=a("#twitter");for(var j in h)a.tweet({username:h[j],callback:n});a(window).resize(k),k();var m=new d;a('form input[type="text"], form input[type="password"], form textarea').bind("focus",function(){a(this).hasClass("is-input-alert")&&a(this).removeClass("is-input-alert")});var w=a("#login-form"),D=a("#register-form"),E=a("#goto-login-form"),F=a("#goto-register-form"),G=a("#login"),H=a('input[name="username"]'),I=a('input[name="password"]'),J=a("#add-member"),K=a('input[name="newname"]'),L=a('input[name="newusername"]'),M=a('input[name="newpassword"]');a("a",F).bind("click",function(){O()}),a("a",E).bind("click",function(){N()}),H.focus(),G.bind("mouseenter",function(){var a=H.val().trim(),b=I.val().trim();a!==""&&b!==""?Q():(G.addClass("is-button-alert"),a==""&&H.addClass("is-input-alert"),b==""&&I.addClass("is-input-alert"))}).bind("mouseleave",P),G.bind("click",function(b){b.preventDefault(),m.start(),T();var c=w.serializeObject();a.post("/login",c,function(b){if("success"===b.status)window.location=b.data.path;else if("fail"===b.status){U(),m.stop(),ui.error(b.data.message).closable().hide(8e3).effect("fade");switch(b.data.code){case"MISSING_FIELD":var c=b.data.missing;for(var d=0;d<c.length;++d)a('input[name="'+c[d]+'"]').addClass("is-input-alert");break;case"BAD_AUTH":I.val("").focus();break;case"NOT_CONFIRMED":}}},"json")}),J.bind("mouseenter",function(){var a=K.val().trim(),b=L.val().trim(),c=M.val().trim();a!=""&&b!=""&&c!=""?S():(J.addClass("is-button-alert"),a==""&&K.addClass("is-input-alert"),b==""&&L.addClass("is-input-alert"),c==""&&M.addClass("is-input-alert"))}).bind("mouseleave",R),J.bind("click",function(b){b.preventDefault(),m.start(),T();var c=D.serializeObject();c.id=J.data("id"),a.put("/signup",c,function(b){if("success"===b.status)window.location=b.data.path;else if("fail"===b.status){U(),m.stop(),ui.error(b.data.message).closable().hide(8e3).effect("fade");switch(b.data.code){case"MISSING_FIELD":var c=b.data.missing;for(var d=0;d<c.length;++d)a('input[name="'+c[d]+'"]').addClass("is-input-alert");break;case"INVALID_EMAIL":case"DUPLICATE_EMAIL":L.val("").addClass("is-input-alert"),L.focus()}}})}),a(".signin-strategy-btn").click(function(a){T()}),a(".resend-conf").live("click",function(b){packman.start();var c=a(this).itemID();a.post("/resendconf/"+c,{id:c},function(a){packman.stop(),"success"===a.status?ui.notify(a.data.message).closable().hide(8e3).effect("fade"):"error"===a.status&&ui.error(a.data.message).closable().hide(8e3).effect("fade")},"json")});var V=a("#logo-a"),W=a("#logo-b"),X=[V,W];a("#header-left").bind("mouseover",function(){V.hide(),W.show(),f(X[0],X[1]),pulseTimer=a.setIntervalObj(this,500,f,X),pulseCancel=a.setTimeoutObj(this,5e3,g)}).bind("mouseout",function(){g()}),a("textarea").autogrow(),a(".grid-obj-img").live("mouseenter",function(){a(".grid-obj-hover",this.parentNode).show()}),a(".grid-obj-hover").live("mouseleave",function(){a(this).fadeOut(100)});var Y=a("#search-box");navigator.userAgent.indexOf("Firefox")!==-1&&Y.css({padding:"5px 10px"}),Y.bind("keyup search",function(b){var c=a(this).val().trim();v.empty(),""===c&&(c="__clear__"),q(c,function(b){if("success"===b.status){for(var c=0;c<b.data.results.length;c++)a(b.data.results[c]).appendTo(v);v.hasClass("adjustable-grid")?u.collage(!0):u.collage()}else console.log(b.message);r()})}).bind("focus",z),Y.val()!==""&&Y.trigger("keyup"),a(".grid-obj, .trending").live("click",function(b){b.preventDefault();var c=a(this).data();a.put("/hit/"+c.id,function(a){if("error"===a.status)return console.log(a.message);window.location="/"+c.key})}),a(".commentor-input-dummy").bind("focus",function(){a(this).hide(),a(this.nextElementSibling).show(),a(this.nextElementSibling.firstElementChild).focus(),C()}),a(".commentor-input").bind("blur",function(){this.value.trim()==""&&(a(this.parentNode).hide(),a(this).val("").css({height:32}),a(this.parentNode.previousElementSibling).show(),C())}).bind("keyup",C),a(".add-comment").bind("click",function(){var b=a(this.previousElementSibling).val();b=a("<div>").html(b).text().trim();if(b==="")return!1;a(this.previousElementSibling).val("").css({height:32}),a(this.parentNode).hide(),a(this.parentNode.previousElementSibling).show();var c=a(this).itemID();a.put("/comment/"+c,{body:b},function(a){if("error"===a.status)return console.log(a.message);"fail"===a.status&&ui.error(a.data.message).closable().hide(12e3).effect("fade")})}),a(".obj-holder").bind("mouseenter",function(){a(".hearts",this).show()}).bind("mouseleave",function(){a(".hearts",this).hide()}),a(".hearts-wrap img, .hearts-back img").bind("mousedown",function(a){a.preventDefault()}),a(".hearts").each(function(){var b=a(this),c=parseInt(b.data("num")),d=0,e=0,f=a(".hearts-back",this),g=a(".hearts-wrap",this);c>0&&p(g,null,c),f.bind("mouseleave",function(a){p(g,null,c)}).bind("mousemove",function(a){d=a.pageX-f.offset().left,e=p(g,d)}).bind("click",function(b){c=e;var d=f.itemID();a.put("/rate/"+d,{val:e},function(a){if("error"===a.status)return console.log(a.message)})})}),a(".obj-details[data-date]").each(function(){var b=a(this),c=new Date(b.data("date")),d;switch(b.data("type")){case"media":d="Added "+Util.toLocaleString(c,"mmm d, yyyy");break;case"profile":d="Contributor since "+Util.toLocaleString(c,"m/d/yy")}b.text(d)}),a(".birthday").each(function(){var b=a(this);b.text(Util.getAge(b.text()))});var Z=a("#media-form"),_=a("#add-media"),ab=a("#add-media-mask"),bb=a('input[name="post[title]"]'),cb=a('textarea[name="post[body]"]'),db=a('input[name="post[meta.tags]"]'),eb=a('input[name="my_file"]'),fb=a('label[for="post[title]"]'),gb=a('label[for="post[body]"]'),hb=a('label[for="post[meta.tags]"]'),ib=a('label[for="my_file"]');ab.each(function(a){var b=_.outerWidth(),c=_.outerHeight();ab.css({width:b,height:c})}),ab.bind("mouseenter",function(){var a=bb.val().trim(),c=cb.val().trim(),d=eb.val();a!=""&&c!=""&&d!=""?(ab.css("bottom",1e4).hide(),kb()):(_.addClass("is-button-alert"),a==""&&fb.css("color",b.orange),c==""&&gb.css("color",b.orange),d==""&&ib.css("color",b.orange))}).bind("mouseleave",jb),_.bind("mouseleave",function(){ab.css("bottom",0),jb()}),Z.transloadit({wait:!0,autoSubmit:!1,onSuccess:function(b){if(b.ok!="ASSEMBLY_COMPLETED"){alert("Upload failed. Please try again.");return}if(a.isEmpty(b.results)){alert("You must choose a file to contribute.");return}var c=Z.serializeObject();c.params=JSON.parse(c.params),c.assembly=b,a.put("/insert",c,function(b){if("error"===b.status)return console.log(b.message);bb.val(""),cb.val(""),db.val(""),eb=a('input[name="my_file"]')})}})},receiveMedia:function(b){var c=a(b);c.prependTo(v).css({opacity:0}),v.hasClass("adjustable-grid")?u.collage(!0):u.collage(),c.animate({opacity:1},500)},receiveComment:function(b,c){var d=a(b),e=a("#coms-"+c),f=a("#recent-comments");if(f.length>0){a(f.children()[f.children().length-1]).remove(),f.hasClass("no-member")&&a(".comment-title-name",d).remove(),d.hide().css({opacity:0}).appendTo(f),u.collage(!0,d.height());var g=a(".comment-added",d);g.data("ts",g.text()),g.text(Util.getRelativeTime(g.data("ts"))),setTimeout(function(){d.prependTo(f).show(250).animate({opacity:1},500)},100)}else e.length>0&&(d.hide().css({opacity:0}).prependTo(e),a("a.comment-title-parent",d).remove(),u.collage(!0,d.height()),setTimeout(function(){d.show(250).animate({opacity:1},500);var b=a(".comment-added",d);b.data("ts",b.text()),b.text(Util.getRelativeTime(b.data("ts")))},100))},receiveTrends:function(a,b){if(a)return console.log(a);s.receive(b)}}}(jQuery),now.receiveMedia=Island.receiveMedia,now.receiveComment=Island.receiveComment,now.receiveTrends=Island.receiveTrends;