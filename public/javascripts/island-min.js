/*!
 * Island.IO
 * v 0.1
 * Copyright(c) 2012 Sander Pick <sanderpick@gmail.com>
 */Island=function(a){function j(b,c){i%2==0?a(c).fadeTo(500,.75):a(c).fadeTo(500,1),i+=1}function k(){clearInterval(pulseTimer),clearTimeout(pulseCancel),a("#logo-a").show(),a("#logo-b").hide()}function q(){p.hide().html(m[o]),p.fadeIn("fast"),o++,o==m.length&&(o=0)}function r(b){m=m.concat(b),n++;if(n==l.length){a.fisherYates(m);var c=a.setIntervalObj(this,5e3,q);q()}}function s(){a(".comment-added").each(function(b){var c=a(this);c.data("ts")||c.data("ts",c.text()),c.text(Util.getRelativeTime(c.data("ts")))})}function u(b,c){z.empty(),a.get("/search/"+b,c)}function v(){a(".is-video").each(function(b){if(a(this).data().timer)return;var c=a("img",this),d=c.length,e=1,f=setInterval(function(){var b=e===0?d-1:e-1;a(c[b]).hide(),a(c[e]).show(),e+=e==d-1?1-d:1},2e3);a(this).data({timer:f})})}function x(b){var c,d,e,f,g=0,h=[];return{init:function(){d=a(b),this.start()},start:function(){e=d.height(),f=d.children(),a(f[0]).clone().appendTo(d),c=a.setIntervalObj(this,40,this.scroll)},update:function(){clearInterval(c),this.start()},scroll:function(){g-=4;if(-g>=e){g=0;if(h.length!=0){d.empty();for(var a=0;a<h.length;a++)h[a].appendTo(d);this.update()}}d.css({marginTop:g})},receive:function(b){h=[];for(var c=0;c<b.length;c++)h.push(a(b[c]))}}}function C(b){function p(){return Math.min(Math.max(j,(parseInt(c.innerWidth())+h)/(g+h)),k)}var c=a(b),d=50,e=25,f={"482px":1,"231px":"*"},g=231,h=20,i=20,j=2,k=4,l=2,m=0,n=0,o=[];return{collage:function(b,d){a(".grid-obj-hover").hide();var e=p();for(var f=0;f<e;f++)o[f]=0;b&&E()>z.offset().top&&(d=d||0,o[2]=o[3]=E()-c.offset().top+10+d),a(".each-grid-obj").each(function(b){var c=a(this),d=0,f=0,j=Math.max(Math.round(c.outerWidth()/g),1);for(var k=0;k<e-(j-1);k++)d=o[k]<o[d]?k:d;for(k=0;k<j;k++)f=Math.max(f,o[d+k]);for(k=0;k<j;k++)o[d+k]=parseInt(c.outerHeight())+i+f;c.css("left",d*(g+h)+m).css("top",f+n)}),A=Math.max.apply(null,o)}}}function D(){B.css({height:a("#search").height()+A})}function E(){var b=a("#recent-comments").length>0?a("#recent-comments"):a(".obj-comments");return b.length>0?b.offset().top+b.height()+20:0}function G(){E()!=F&&y.collage(!0)}function H(){a(this).fadeOut()}var b={green:"#b1dc36",orange:"#d04c38",blue:"#4bb8d7",pink:"#d12b83",lightgreen:"#eff8d7",lightorange:"#f6dbd7",black:"#1a1a1a",darkgray:"#404040",gray:"#808080",lightgray:"#b3b3b3",bordergray:"#cdcdcd",backgray:"#fcfcfb",mattegray:"#f2f2f2"},c,d,e=0,f={start:function(){d=setInterval(this.go,250),this.go()},stop:function(){clearInterval(d)},go:function(){e>350?e=0:e+=20,c.css({left:e})}},g={lines:17,length:0,width:3,radius:40,rotate:0,color:"#000",speed:2.2,trail:100,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},h=function(){var b=a(".signin-spinner").get(0),c=(new Spinner(g)).spin(b);return{start:function(){c.spin(b)},stop:function(){c.stop()}}},i=0,l=[],m=[],n=0,o=0,p,t=function(b,c,d){!d&&d!==0&&(c<10?d=0:c<30?d=1:c<55?d=2:c<80?d=3:c<105?d=4:d=5),a(b.children()).hide();for(var e=0;e<d;e++)a(b.children()[e]).show();return d},w,y,z,A,B,F;return{go:function(){function m(){var b=a(".signin-bg > img");if(b.length===0)return;var c=a(this),d=b.width()/b.height();b.width(c.width()),b.height(c.width()/d)}function P(){q.animate({opacity:[0,"easeOutExpo"],left:["+=300","linear"]},200,"easeOutExpo",function(){q.hide(),q.css({opacity:1,left:0}),o.fadeIn("fast"),J.focus()}),A.hide(),H.show()}function Q(){o.animate({opacity:[0,"easeOutExpo"],left:["-=300","linear"]},200,function(){o.hide(),o.css({opacity:1,left:0}),q.fadeIn("fast"),M.focus()}),H.hide(),A.show()}function R(){I.removeClass("is-button-alert"),S()}function S(){J.removeClass("is-input-alert"),K.removeClass("is-input-alert")}function T(){L.removeClass("is-button-alert"),U()}function U(){M.removeClass("is-input-alert"),N.removeClass("is-input-alert"),O.removeClass("is-input-alert")}function V(){a(".signin-strategies").hide(),a(".signin-controls").hide(),a(".signin-forms").hide(),a(".signin-almost-there").hide(),a(".signin-spinner").show()}function W(){a(".signin-strategies").show(),a(".signin-controls").show(),a(".signin-forms").show(),a(".signin-almost-there").show(),a(".signin-spinner").hide()}function lb(){cb.show(),bb.removeClass("is-button-alert"),mb()}function mb(){hb.css("color","gray"),ib.css("color","gray"),kb.css("color","gray")}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},a.setTimeoutObj=function(a,b,c,d){return setTimeout(function(){c.apply(a,d)},b)},a.setIntervalObj=function(a,b,c,d){return setInterval(function(){c.apply(a,d)},b)},a.fisherYates=function(a){var b=a.length;if(b==0)return!1;while(--b){var c=Math.floor(Math.random()*(b+1)),d=a[b],e=a[c];a[b]=e,a[c]=d}},a.isEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},a.put=function(b,c,d){"function"==typeof c&&(d=c,c={}),c._method="PUT",a.post(b,c,d,"json")},a.fn.serializeObject=function(){var b={},c=this.serializeArray();return a.each(c,function(){b[this.name]?(b[this.name].push||(b[this.name]=[b[this.name]]),b[this.name].push(this.value.trim()||"")):b[this.name]=this.value.trim()||""}),b},a.fn.itemID=function(){try{var b=a(this).attr("id").split("-");return b[b.length-1]}catch(c){return null}},w=new x("#trend"),w.init(),a.setIntervalObj(this,5e3,s),s(),y=new C("#grid"),z=a("#grid"),B=a(".grid-wrap");if(z.hasClass("adjustable-grid")){F=E();var d=a(".trending-media-wrap").length>0?a(".trending-media-wrap"):a(".single-left");B.css({top:d.offset().top+d.height()+40}),y.collage(!0)}else y.collage();(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i))&&a("#footer").hide();if(window.location.hash!=="")try{window.history.replaceState("","",window.location.pathname+window.location.search)}catch(e){}a(".jp-jplayer").each(function(b){a("#"+a(this).attr("id")).jPlayer({ready:function(b){a(this).jPlayer("setMedia",{mp3:a(this).data("src")})},play:function(){a(this).jPlayer("pauseOthers")},swfPath:"https://d271mvlc6gc7bl.cloudfront.net/main/jplayer/js",wmode:"window",cssSelectorAncestor:"#jp_container_"+(b+1)})}),a("video").each(function(){jwplayer(a(this).attr("id")).setup({flashplayer:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/player.swf",skin:"https://d271mvlc6gc7bl.cloudfront.net/main/jwplayer/skins/bekle.zip"})}),v(),c=a("#landing-loader"),c.length===0&&(f.start=function(){}),twitterNames=a("#twitter-names").text().split(",");for(var g=0;g<twitterNames.length;g++)twitterNames[g]!="undefined"&&twitterNames[g]!=""&&l.push(twitterNames[g]);p=a("#twitter");for(var i in l)a.tweet({username:l[i],callback:r});a(window).resize(m),m();var n=new h;a('form input[type="text"], form input[type="password"], form textarea').bind("focus",function(){a(this).hasClass("is-input-alert")&&a(this).removeClass("is-input-alert")});var o=a("#login-form"),q=a("#register-form"),A=a("#goto-login-form"),H=a("#goto-register-form"),I=a("#login"),J=a('input[name="username"]'),K=a('input[name="password"]'),L=a("#add-member"),M=a('input[name="newname"]'),N=a('input[name="newusername"]'),O=a('input[name="newpassword"]');a("a",H).bind("click",function(){Q()}),a("a",A).bind("click",function(){P()}),J.focus(),I.bind("mouseenter",function(){var a=J.val().trim(),b=K.val().trim();a!==""&&b!==""?S():(I.addClass("is-button-alert"),a==""&&J.addClass("is-input-alert"),b==""&&K.addClass("is-input-alert"))}).bind("mouseleave",R),I.bind("click",function(b){b.preventDefault(),n.start(),V();var c=o.serializeObject();a.post("/login",c,function(b){if("success"===b.status)window.location=b.data.path;else if("fail"===b.status){W(),n.stop(),ui.error(b.data.message).closable().hide(8e3).effect("fade");switch(b.data.code){case"MISSING_FIELD":var c=b.data.missing;for(var d=0;d<c.length;++d)a('input[name="'+c[d]+'"]').addClass("is-input-alert");break;case"BAD_AUTH":K.val("").focus();break;case"NOT_CONFIRMED":}}},"json")}),L.bind("mouseenter",function(){var a=M.val().trim(),b=N.val().trim(),c=O.val().trim();a!=""&&b!=""&&c!=""?U():(L.addClass("is-button-alert"),a==""&&M.addClass("is-input-alert"),b==""&&N.addClass("is-input-alert"),c==""&&O.addClass("is-input-alert"))}).bind("mouseleave",T),L.bind("click",function(b){b.preventDefault(),n.start(),V();var c=q.serializeObject();c.id=L.data("id"),a.put("/signup",c,function(b){if("success"===b.status)window.location=b.data.path;else if("fail"===b.status){W(),n.stop(),ui.error(b.data.message).closable().hide(8e3).effect("fade");switch(b.data.code){case"MISSING_FIELD":var c=b.data.missing;for(var d=0;d<c.length;++d)a('input[name="'+c[d]+'"]').addClass("is-input-alert");break;case"INVALID_EMAIL":case"DUPLICATE_EMAIL":N.val("").addClass("is-input-alert"),N.focus()}}})}),a(".signin-strategy-btn").click(function(a){V()}),a(".resend-conf").live("click",function(b){f.start();var c=a(this).itemID();a.post("/resendconf/"+c,{id:c},function(a){f.stop(),"success"===a.status?ui.notify(a.data.message).closable().hide(8e3).effect("fade"):"error"===a.status&&ui.error(a.data.message).closable().hide(8e3).effect("fade")},"json")});var X=a("#logo-a"),Y=a("#logo-b"),Z=[X,Y];a("#header-left").bind("mouseover",function(){X.hide(),Y.show(),j(Z[0],Z[1]),pulseTimer=a.setIntervalObj(this,500,j,Z),pulseCancel=a.setTimeoutObj(this,5e3,k)}).bind("mouseout",function(){k()}),a("textarea").autogrow(),a(".grid-obj-img").live("mouseenter",function(){a(".grid-obj-hover",this.parentNode).show()}),a(".grid-obj-hover").live("mouseleave",function(){a(this).fadeOut(100)});var _=a("#search-box");navigator.userAgent.indexOf("Firefox")!==-1&&_.css({padding:"5px 10px"}),_.bind("keyup search",function(b){var c=a(this).val().trim();z.empty(),""===c&&(c="__clear__"),u(c,function(b){if("success"===b.status){for(var c=0;c<b.data.results.length;c++)a(b.data.results[c]).appendTo(z);z.hasClass("adjustable-grid")?y.collage(!0):y.collage()}else console.log(b.message);v()})}).bind("focus",D),_.val()!==""&&_.trigger("keyup"),a(".grid-obj, .trending").live("click",function(b){b.preventDefault();var c=a(this).data();a.put("/hit/"+c.id,function(a){if("error"===a.status)return console.log(a.message);window.location="/"+c.key})}),a(".commentor-input-dummy").bind("focus",function(){a(this).hide(),a(this.nextElementSibling).show(),a(this.nextElementSibling.firstElementChild).focus(),G()}),a(".commentor-input").bind("blur",function(){this.value.trim()==""&&(a(this.parentNode).hide(),a(this).val("").css({height:32}),a(this.parentNode.previousElementSibling).show(),G())}).bind("keyup",G),a(".add-comment").bind("click",function(){var b=a(this.previousElementSibling).val();b=a("<div>").html(b).text().trim();if(b==="")return!1;a(this.previousElementSibling).val("").css({height:32}),a(this.parentNode).hide(),a(this.parentNode.previousElementSibling).show();var c=a(this).itemID();a.put("/comment/"+c,{body:b},function(a){if("error"===a.status)return console.log(a.message);"fail"===a.status&&ui.error(a.data.message).closable().hide(12e3).effect("fade")})}),a(".obj-holder").bind("mouseenter",function(){a(".hearts",this).show()}).bind("mouseleave",function(){a(".hearts",this).hide()}),a(".hearts-wrap img, .hearts-back img").bind("mousedown",function(a){a.preventDefault()}),a(".hearts").each(function(){var b=a(this),c=parseInt(b.data("num")),d=0,e=0,f=a(".hearts-back",this),g=a(".hearts-wrap",this);c>0&&t(g,null,c),f.bind("mouseleave",function(a){t(g,null,c)}).bind("mousemove",function(a){d=a.pageX-f.offset().left,e=t(g,d)}).bind("click",function(b){c=e;var d=f.itemID();a.put("/rate/"+d,{val:e},function(a){if("error"===a.status)return console.log(a.message)})})}),a(".obj-details[data-date]").each(function(){var b=a(this),c=new Date(b.data("date")),d;switch(b.data("type")){case"media":d="Added "+Util.toLocaleString(c,"mmm d, yyyy");break;case"profile":d="Contributor since "+Util.toLocaleString(c,"m/d/yy")}b.text(d)}),a(".birthday").each(function(){var b=a(this);b.text(Util.getAge(b.text()))});var ab=a("#media-form"),bb=a("#add-media"),cb=a("#add-media-mask"),db=a('input[name="post[title]"]'),eb=a('textarea[name="post[body]"]'),fb=a('input[name="post[meta.tags]"]'),gb=a('input[name="my_file"]'),hb=a('label[for="post[title]"]'),ib=a('label[for="post[body]"]'),jb=a('label[for="post[meta.tags]"]'),kb=a('label[for="my_file"]');cb.each(function(a){var b=bb.outerWidth(),c=bb.outerHeight();cb.css({width:b,height:c})}),cb.bind("mouseenter",function(){var a=db.val().trim(),c=eb.val().trim(),d=gb.val();a!=""&&c!=""&&d!=""?(cb.css("bottom",1e4).hide(),mb()):(bb.addClass("is-button-alert"),a==""&&hb.css("color",b.orange),c==""&&ib.css("color",b.orange),d==""&&kb.css("color",b.orange))}).bind("mouseleave",lb),bb.bind("mouseleave",function(){cb.css("bottom",0),lb()}),ab.transloadit({wait:!0,autoSubmit:!1,onSuccess:function(b){if(b.ok!="ASSEMBLY_COMPLETED"){alert("Upload failed. Please try again.");return}if(a.isEmpty(b.results)){alert("You must choose a file to contribute.");return}var c=ab.serializeObject();c.params=JSON.parse(c.params),c.assembly=b,a.put("/insert",c,function(b){if("error"===b.status)return console.log(b.message);db.val(""),eb.val(""),fb.val(""),gb=a('input[name="my_file"]')})}})},receiveMedia:function(b){var c=a(b);c.prependTo(z).css({opacity:0}),z.hasClass("adjustable-grid")?y.collage(!0):y.collage(),c.animate({opacity:1},500)},receiveComment:function(b,c){var d=a(b),e=a("#coms-"+c),f=a("#recent-comments");if(f.length>0){a(f.children()[f.children().length-1]).remove(),f.hasClass("no-member")&&a(".comment-title-name",d).remove(),d.hide().css({opacity:0}).appendTo(f),y.collage(!0,d.height());var g=a(".comment-added",d);g.data("ts",g.text()),g.text(Util.getRelativeTime(g.data("ts"))),setTimeout(function(){d.prependTo(f).show(250).animate({opacity:1},500)},100)}else e.length>0&&(d.hide().css({opacity:0}).prependTo(e),a("a.comment-title-parent",d).remove(),y.collage(!0,d.height()),setTimeout(function(){d.show(250).animate({opacity:1},500);var b=a(".comment-added",d);b.data("ts",b.text()),b.text(Util.getRelativeTime(b.data("ts")))},100))},receiveTrends:function(a,b){if(a)return console.log(a);w.receive(b)}}}(jQuery),now.receiveMedia=Island.receiveMedia,now.receiveComment=Island.receiveComment,now.receiveTrends=Island.receiveTrends;